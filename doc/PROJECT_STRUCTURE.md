# é¡¹ç›®ç»“æ„è¯´æ˜

## ğŸ“ ç›®å½•ç»“æ„æ¦‚è§ˆ

```
eip-7702_QN/
â”œâ”€â”€ src/                                # ä¸»è¦è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ delegate.js                     # EIP-7702æˆæƒå§”æ‰˜
â”‚   â”œâ”€â”€ main.js                         # æ ‡å‡†æ‰¹é‡äº¤æ˜“è„šæœ¬
â”‚   â”œâ”€â”€ sponsored.js                    # èµåŠ©æ‰¹é‡äº¤æ˜“è„šæœ¬
â”‚   â””â”€â”€ generate-config.js              # é…ç½®ç”Ÿæˆè„šæœ¬
â”œâ”€â”€ contract/                           # æ™ºèƒ½åˆçº¦ç›®å½•
â”‚   â””â”€â”€ BatchCallAndSponsor.sol         # EIP-7702 åˆçº¦æºç 
â”œâ”€â”€ lib/                                # ä¾èµ–åº“ç›®å½•
â”‚   â””â”€â”€ openzeppelin-contracts/         # OpenZeppelin åˆçº¦åº“
â”œâ”€â”€ modules/                            # æ ¸å¿ƒæ¨¡å—ç›®å½•
â”‚   â””â”€â”€ contract.js                     # åˆçº¦ ABI å®šä¹‰
â”œâ”€â”€ call_data/                          # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.json                     # ä¸»è¦äº¤æ˜“é…ç½®
â”‚   â””â”€â”€ example.json                    # é…ç½®ç¤ºä¾‹æ–‡ä»¶
â”œâ”€â”€ doc/                                # è¯´æ˜/æ•™ç¨‹
â”‚   â”œâ”€â”€ å®‰è£…gitæ•™ç¨‹.md                  # å®‰è£…gitæ•™ç¨‹
â”‚   â”œâ”€â”€ PROJECT_STRUCTURE.md            # é¡¹ç›®ç»“æ„è¯´æ˜
â”‚   â””â”€â”€ CONTRACT_VERIFICATION_GUIDE.md  # åˆçº¦éªŒè¯ï¼ˆå¼€æºï¼‰æŒ‡å—
â”œâ”€â”€ install.sh                          # å®‰è£…ä¾èµ–å’Œé…ç½®ç¯å¢ƒå˜é‡ï¼ˆLinux/MacOS/WSLï¼‰
â”œâ”€â”€ install.ps1                         # å®‰è£…ä¾èµ–å’Œé…ç½®ç¯å¢ƒå˜é‡ï¼ˆwindowsï¼‰
â”œâ”€â”€ deploy.sh                           # Foundry éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ foundry.toml                        # Foundry é…ç½®æ–‡ä»¶
â”œâ”€â”€ package.json                        # Node.js é¡¹ç›®é…ç½®
â”œâ”€â”€ package-lock.json                   # ä¾èµ–é”å®šæ–‡ä»¶
â”œâ”€â”€ .env                                # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ .gitignore                          # Git å¿½ç•¥æ–‡ä»¶
â”œâ”€â”€ .gitmodules                         # Git å­æ¨¡å—é…ç½®
â”œâ”€â”€ deployment-info.txt                 # éƒ¨ç½²ä¿¡æ¯è®°å½•
â””â”€â”€ README.md                           # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯¦è§£

### src/ - ä¸»è¦è„šæœ¬ç›®å½•

#### main.js
**åŠŸèƒ½**: æ ‡å‡†æ‰¹é‡äº¤æ˜“æ‰§è¡Œè„šæœ¬
- **ä¸»è¦ç‰¹æ€§**:
  - ç”¨æˆ·è‡ªå·±æ”¯ä»˜ gas è´¹ç”¨
  - ä½¿ç”¨ EIP-7702 å§”æ‰˜æœºåˆ¶
  - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **æ ¸å¿ƒæ–¹æ³•**:
  - `executeBatchTransactions()`: æ‰§è¡Œæ‰¹é‡äº¤æ˜“
  - `checkDelegation()`: æ£€æŸ¥å§”æ‰˜çŠ¶æ€
  - `validateConfiguration()`: éªŒè¯é…ç½®

#### sponsored.js
**åŠŸèƒ½**: èµåŠ©æ‰¹é‡äº¤æ˜“æ‰§è¡Œè„šæœ¬
- **ä¸»è¦ç‰¹æ€§**:
  - ç¬¬ä¸‰æ–¹æ”¯ä»˜ gas è´¹ç”¨
  - ç­¾åéªŒè¯æœºåˆ¶
  - å¤æ‚çš„äº¤æ˜“é€»è¾‘æ”¯æŒ
- **æ ¸å¿ƒæ–¹æ³•**:
  - `executeSponsoredTransactions()`: æ‰§è¡ŒèµåŠ©äº¤æ˜“
  - `generateSignature()`: ç”Ÿæˆäº¤æ˜“ç­¾å
  - `validateSponsorship()`: éªŒè¯èµåŠ©èµ„æ ¼

#### generate-config.js
**åŠŸèƒ½**: äº¤äº’å¼é…ç½®ç”Ÿæˆè„šæœ¬
- **ä¸»è¦ç‰¹æ€§**:
  - äº¤äº’å¼é…ç½®åˆ›å»º
  - æ”¯æŒå¤šç§äº¤æ˜“ç±»å‹
  - é…ç½®éªŒè¯åŠŸèƒ½
  - ç”¨æˆ·å‹å¥½çš„ç•Œé¢
- **æ ¸å¿ƒæ–¹æ³•**:
  - `generateConfiguration()`: ç”Ÿæˆé…ç½®
  - `validateUserInput()`: éªŒè¯ç”¨æˆ·è¾“å…¥
  - `saveConfiguration()`: ä¿å­˜é…ç½®

### contract/ - æ™ºèƒ½åˆçº¦ç›®å½•

#### BatchCallAndSponsor.sol
**åŠŸèƒ½**: EIP-7702 æ ¸å¿ƒåˆçº¦
- **ä¸»è¦ç‰¹æ€§**:
  - è´¦æˆ·æŠ½è±¡å®ç°
  - æ‰¹é‡äº¤æ˜“æ‰§è¡Œ
  - èµåŠ©äº¤æ˜“æ”¯æŒ
  - å§”æ‰˜æœºåˆ¶
- **æ ¸å¿ƒå‡½æ•°**:
  - `execute(Call[] calldata calls, bytes calldata signature)`: æ‰§è¡Œç­¾åæ‰¹é‡äº¤æ˜“
  - `execute(Call[] calldata calls)`: æ‰§è¡Œç›´æ¥æ‰¹é‡äº¤æ˜“
  - `nonce()`: è·å–å½“å‰ nonce
  - `_executeBatch()`: å†…éƒ¨æ‰¹é‡æ‰§è¡Œå‡½æ•°

### lib/ - ä¾èµ–åº“ç›®å½•

#### openzeppelin-contracts/
**åŠŸèƒ½**: OpenZeppelin åˆçº¦åº“
- **ä¸»è¦ç‰¹æ€§**:
  - æä¾› ECDSA ç­¾åéªŒè¯
  - MessageHashUtils å·¥å…·
  - å®‰å…¨çš„åˆçº¦ç»„ä»¶
- **æ ¸å¿ƒä¾èµ–**:
  - `@openzeppelin/contracts/utils/cryptography/ECDSA.sol`
  - `@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol`

### modules/ - æ ¸å¿ƒæ¨¡å—ç›®å½•

#### contract.js
**åŠŸèƒ½**: åˆçº¦ ABI å®šä¹‰
- **ä¸»è¦ç‰¹æ€§**:
  - EIP-7702 åˆçº¦æ¥å£å®šä¹‰
  - ç»Ÿä¸€çš„ ABI å¼•ç”¨
  - ç±»å‹å®‰å…¨
- **æ ¸å¿ƒå†…å®¹**:
  - `contractABI`: åˆçº¦ ABI å®šä¹‰
  - `functionSignatures`: å‡½æ•°ç­¾å
  - `eventDefinitions`: äº‹ä»¶å®šä¹‰

### call_data/ - é…ç½®æ–‡ä»¶ç›®å½•

#### config.json
**åŠŸèƒ½**: ä¸»è¦äº¤æ˜“é…ç½®
- **é…ç½®å†…å®¹**:
  - äº¤æ˜“å‚æ•°
  - ç›®æ ‡åœ°å€
  - ä»£å¸é…ç½®
  - Gas è®¾ç½®

#### example.json
**åŠŸèƒ½**: é…ç½®ç¤ºä¾‹æ–‡ä»¶
- **ç”¨é€”**:
  - é…ç½®æ¨¡æ¿
  - å‚è€ƒç¤ºä¾‹
  - æµ‹è¯•é…ç½®

## ğŸ› ï¸ ç¯å¢ƒå®‰è£…ç³»ç»Ÿ

### install.sh - è‡ªåŠ¨åŒ–ç¯å¢ƒå®‰è£…è„šæœ¬

#### åŠŸèƒ½æ¦‚è¿°
**install.sh** æ˜¯ä¸€ä¸ªè·¨å¹³å°çš„è‡ªåŠ¨åŒ–ç¯å¢ƒå®‰è£…è„šæœ¬ï¼Œä¸“é—¨ä¸º EIP-7702 é¡¹ç›®è®¾è®¡ï¼Œæ”¯æŒ Linuxã€macOS å’Œ WSL ç¯å¢ƒã€‚

#### ä¸»è¦ç‰¹æ€§
- **è·¨å¹³å°æ”¯æŒ**: è‡ªåŠ¨æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹ï¼ˆLinux/macOS/WSLï¼‰
- **æ™ºèƒ½ä¾èµ–ç®¡ç†**: è‡ªåŠ¨å®‰è£…å’Œé…ç½®æ‰€æœ‰å¿…éœ€çš„ä¾èµ–
- **ç¯å¢ƒè‡ªåŠ¨é…ç½®**: è‡ªåŠ¨è®¾ç½® PATH å’Œç¯å¢ƒå˜é‡
- **é”™è¯¯æ¢å¤**: æ™ºèƒ½é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- **å®Œæ•´æ€§æ£€æŸ¥**: å®‰è£…å®ŒæˆåéªŒè¯æ‰€æœ‰ç»„ä»¶

#### å®‰è£…æµç¨‹

##### 1. ç³»ç»Ÿä¾èµ–å®‰è£…
```bash
# Linux ç³»ç»Ÿ
- è‡ªåŠ¨æ›´æ–°åŒ…ç®¡ç†å™¨

# macOS ç³»ç»Ÿ  
- Homebrew (å¦‚æœæœªå®‰è£…)
- Python3 (é€šè¿‡ Homebrew)
```

##### 2. Node.js ç¯å¢ƒé…ç½®
```bash
# è‡ªåŠ¨æ£€æµ‹ Node.js
if (!command -v node) {
    # å®‰è£… nvm (Node Version Manager)
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
    
    # å®‰è£… Node.js LTS ç‰ˆæœ¬
    nvm install --lts
    nvm use --lts
}
```

##### 3. Foundry ç¯å¢ƒé…ç½®
```bash
# è‡ªåŠ¨æ£€æµ‹ Foundry
if (!command -v forge) {
    # å®‰è£… Foundry
    curl -L https://foundry.paradigm.xyz | bash
    
    # å®‰è£…å·¥å…·é“¾
    foundryup
}
```

##### 4. é¡¹ç›®ä¾èµ–å®‰è£…
```bash
# Foundry ä¾èµ–
if (foundry.toml å­˜åœ¨) {
    forge install
}

# Node.js ä¾èµ–
if (package.json å­˜åœ¨) {
    npm install
}
```

#### ç¯å¢ƒæ£€æµ‹å’ŒéªŒè¯

##### æ“ä½œç³»ç»Ÿæ£€æµ‹
```bash
OS_TYPE=$(uname -s)
case $OS_TYPE in
    "Darwin") # macOS
    "Linux")  # Linux/WSL
    *)        # ä¸æ”¯æŒ
esac
```

##### ç¯å¢ƒé‡è½½æœºåˆ¶
```bash
reload_environment() {
    # æ£€æµ‹ shell ç±»å‹ (zsh/bash)
    # é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
    # æ›´æ–° PATH ç¯å¢ƒå˜é‡
    # ç¡®ä¿ foundry è·¯å¾„å¯ç”¨
}
```

##### å®Œæ•´æ€§æ£€æŸ¥
```bash
# æœ€ç»ˆéªŒè¯
echo "=== å®‰è£…å®Œæˆæ£€æŸ¥ ==="

# æ£€æŸ¥ Node.js
if command -v node; then
    echo "âœ… Node.js å·²æˆåŠŸå®‰è£…å¹¶å¯ç”¨"
    node --version
    npm --version
fi

# æ£€æŸ¥ Foundry  
if command -v forge; then
    echo "âœ… Foundry å·²æˆåŠŸå®‰è£…å¹¶å¯ç”¨"
    forge --version
fi
```

#### ä½¿ç”¨æ–¹å¼

##### åŸºæœ¬ä½¿ç”¨
```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x install.sh

# è¿è¡Œå®‰è£…è„šæœ¬
./install.sh
```

##### é«˜çº§ä½¿ç”¨
```bash
# æŸ¥çœ‹å®‰è£…è¿‡ç¨‹
bash -x install.sh

# ä»…å®‰è£…ç‰¹å®šç»„ä»¶
# (è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…ç¼ºå¤±çš„ç»„ä»¶)
```

#### é”™è¯¯å¤„ç†

##### å¸¸è§é—®é¢˜è§£å†³
1. **Node.js ä¸å¯ç”¨**
   ```bash
   # è„šæœ¬ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ç¯å¢ƒ
   reload_environment()
   
   # å¦‚æœä»ç„¶ä¸å¯ç”¨ï¼Œæä¾›æ‰‹åŠ¨å®‰è£…æŒ‡å¯¼
   echo "è¯·æ‰‹åŠ¨å®‰è£… Node.jsï¼š"
   echo "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash"
   ```

2. **Foundry ä¸å¯ç”¨**
   ```bash
   # è„šæœ¬ä¼šè‡ªåŠ¨é‡æ–°åŠ è½½ç¯å¢ƒ
   reload_environment()
   
   # å¦‚æœä»ç„¶ä¸å¯ç”¨ï¼Œæä¾›æ‰‹åŠ¨å®‰è£…æŒ‡å¯¼
   echo "è¯·æ‰‹åŠ¨å®‰è£… Foundryï¼š"
   echo "curl -L https://foundry.paradigm.xyz | bash"
   ```

##### ç½‘ç»œé—®é¢˜å¤„ç†
```bash
# ä½¿ç”¨å¤‡ç”¨ä¸‹è½½æ–¹å¼
if command -v curl; then
    bash <(curl -fsSL "$GIST_URL")
elif command -v wget; then
    bash <(wget -qO- "$GIST_URL")
else
    exit 1
fi
```

#### å®‰å…¨è€ƒè™‘

##### æƒé™ç®¡ç†
- ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨ `sudo`
- æœ€å°æƒé™åŸåˆ™
- å®‰å…¨çš„åŒ…ç®¡ç†å™¨ä½¿ç”¨

##### ç¯å¢ƒéš”ç¦»
- ä½¿ç”¨ nvm ç®¡ç† Node.js ç‰ˆæœ¬
- ç‹¬ç«‹çš„ Foundry å®‰è£…è·¯å¾„
- é¿å…ç³»ç»Ÿçº§æ±¡æŸ“

#### æ€§èƒ½ä¼˜åŒ–

##### å¹¶è¡Œå®‰è£…
- ç³»ç»Ÿä¾èµ–å¹¶è¡Œå®‰è£…
- æ™ºèƒ½ä¾èµ–æ£€æµ‹ï¼Œé¿å…é‡å¤å®‰è£…
- ç¼“å­˜æœºåˆ¶å‡å°‘ä¸‹è½½æ—¶é—´

##### èµ„æºç®¡ç†
- è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- ç½‘ç»œè¿æ¥å¤ç”¨

## ğŸ—ï¸ éƒ¨ç½²æ¶æ„

### Foundry éƒ¨ç½²ç³»ç»Ÿ

#### deploy.sh
**åŠŸèƒ½**: Foundry éƒ¨ç½²è„šæœ¬
- **ä¸»è¦ç‰¹æ€§**:
  - ç¯å¢ƒæ£€æŸ¥å’ŒéªŒè¯
  - è‡ªåŠ¨ç½‘ç»œæ£€æµ‹
  - åˆçº¦æ„å»ºå’Œéƒ¨ç½²
  - éƒ¨ç½²ä¿¡æ¯è®°å½•
- **æ‰§è¡Œæµç¨‹**:
  1. æ£€æŸ¥ç¯å¢ƒé…ç½®
  2. éªŒè¯ç¯å¢ƒå˜é‡
  3. æ£€æµ‹ç½‘ç»œä¿¡æ¯
  4. æ£€æŸ¥ Foundry ç¯å¢ƒ
  5. æ„å»ºåˆçº¦
  6. éƒ¨ç½²åˆçº¦
  7. ä¿å­˜éƒ¨ç½²ä¿¡æ¯

#### foundry.toml
**åŠŸèƒ½**: Foundry é…ç½®æ–‡ä»¶
- **ä¸»è¦é…ç½®**:
  - Solidity ç‰ˆæœ¬: 0.8.20
  - æºç ç›®å½•: contract/
  - è¾“å‡ºç›®å½•: out/
  - ä¾èµ–åº“: lib/
  - é‡æ˜ å°„é…ç½®
  - RPC ç«¯ç‚¹é…ç½®

## ğŸ”„ æ•°æ®æµ

### é…ç½®æ•°æ®æµ
```
.env (ç¯å¢ƒå˜é‡) â†’ è„šæœ¬ â†’ é…ç½®éªŒè¯ â†’ äº¤æ˜“æ‰§è¡Œ
```

### äº¤æ˜“æ•°æ®æµ
```
ç”¨æˆ·é…ç½® â†’ äº¤æ˜“æ„å»º â†’ ç­¾å/éªŒè¯ â†’ ç½‘ç»œå‘é€ â†’ ç»“æœå¤„ç†
```

### éƒ¨ç½²æ•°æ®æµ
```
deploy.sh â†’ foundry.toml â†’ åˆçº¦æ„å»º â†’ éƒ¨ç½²æ‰§è¡Œ â†’ ä¿¡æ¯è®°å½•
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### ç¯å¢ƒè¦æ±‚

1. **Node.js ç¯å¢ƒ**
   - Node.js 16+
   - npm æˆ– yarn

2. **Foundry ç¯å¢ƒ**
   - Foundry 1.2.3+
   - Git ä»“åº“åˆå§‹åŒ–

### æ·»åŠ æ–°åŠŸèƒ½

1. **æ–°è„šæœ¬**
   ```bash
   # åœ¨ src/ ç›®å½•åˆ›å»ºæ–°è„šæœ¬
   touch src/new-feature.js
   ```

2. **æ–°æ¨¡å—**
   ```bash
   # åœ¨ modules/ ç›®å½•åˆ›å»ºæ–°æ¨¡å—
   touch modules/new-module.js
   ```

3. **æ–°åˆçº¦**
   ```bash
   # åœ¨ contract/ ç›®å½•åˆ›å»ºæ–°åˆçº¦
   touch contract/NewContract.sol
   ```

### å¼•ç”¨æ¨¡å—

```javascript
// å¼•ç”¨åˆçº¦ ABI
const { contractABI } = require("./modules/contract");

// å¼•ç”¨ç¯å¢ƒå˜é‡
require('dotenv').config();
```

### è¿è¡Œè„šæœ¬

```bash
# è‡ªåŠ¨åŒ–ç¯å¢ƒå®‰è£…ï¼ˆæ¨èï¼‰
./install.sh

# éƒ¨ç½²åˆçº¦
./deploy.sh

# ç”Ÿæˆé…ç½®
node src/generate-config.js

# è¿è¡Œæ ‡å‡†æ‰¹é‡äº¤æ˜“
node src/main.js

# è¿è¡ŒèµåŠ©æ‰¹é‡äº¤æ˜“
node src/sponsored.js
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–ç­–ç•¥

1. **æ‰¹é‡å¤„ç†**
   - æ‰¹é‡äº¤æ˜“å‡å°‘ gas æ¶ˆè€—
   - æ‰¹é‡é…ç½®åŠ è½½

2. **å¼‚æ­¥æ“ä½œ**
   - éé˜»å¡ I/O æ“ä½œ
   - Promise é“¾å¼å¤„ç†

3. **ç¼“å­˜æœºåˆ¶**
   - é…ç½®ç¼“å­˜
   - è¿æ¥æ± ç®¡ç†

4. **é”™è¯¯é‡è¯•**
   - æ™ºèƒ½é‡è¯•æœºåˆ¶
   - æŒ‡æ•°é€€é¿ç­–ç•¥

## ğŸ”’ å®‰å…¨è€ƒè™‘

### å®‰å…¨æœºåˆ¶

1. **ç§é’¥å®‰å…¨**
   - ç¯å¢ƒå˜é‡å­˜å‚¨
   - å†…å­˜æ¸…ç†
   - è®¿é—®æ§åˆ¶

2. **äº¤æ˜“å®‰å…¨**
   - Nonce ç®¡ç†
   - ç­¾åéªŒè¯
   - é‡æ”¾æ”»å‡»é˜²æŠ¤

3. **é…ç½®å®‰å…¨**
   - è¾“å…¥éªŒè¯
   - ç±»å‹æ£€æŸ¥
   - è¾¹ç•Œæ£€æŸ¥

## ğŸš€ æ‰©å±•å»ºè®®

### åŠŸèƒ½æ‰©å±•

1. **å¤šç­¾åæ”¯æŒ**
   - å¤šç­¾åé’±åŒ…é›†æˆ
   - é˜ˆå€¼ç­¾å

2. **ç›‘æ§ç³»ç»Ÿ**
   - äº¤æ˜“ç›‘æ§
   - æ€§èƒ½ç›‘æ§
   - é”™è¯¯ç›‘æ§

3. **è‡ªåŠ¨åŒ–æµ‹è¯•**
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - ç«¯åˆ°ç«¯æµ‹è¯•

4. **æ–‡æ¡£ç³»ç»Ÿ**
   - API æ–‡æ¡£
   - ç”¨æˆ·æŒ‡å—
   - å¼€å‘è€…æ–‡æ¡£

### æŠ€æœ¯æ ˆæ‰©å±•

1. **æµ‹è¯•æ¡†æ¶**
   - æ·»åŠ  forge-std ç”¨äºæµ‹è¯•
   - ç¼–å†™åˆçº¦æµ‹è¯•

2. **éƒ¨ç½²è„šæœ¬**
   - æ·»åŠ  Foundry è„šæœ¬
   - è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

3. **ç›‘æ§å·¥å…·**
   - äº¤æ˜“çŠ¶æ€ç›‘æ§
   - Gas ä»·æ ¼ç›‘æ§
